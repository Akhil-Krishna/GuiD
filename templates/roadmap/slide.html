{% extends "main/base.html" %}


{% block styling %}
<style>
    /* General Styles */
    body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: 'Arial', sans-serif;
    }

    .slide-container {
        margin: 20px auto;
        padding: 20px;
        background-color: #1e1e1e;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    h1 {
        font-size: 2.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 2rem;
        color: #00bcd4;
    }

    .enhancer-button {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: #00bcd4;
        color: #121212;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .enhancer-button:hover {
        transform: scale(1.2);
        box-shadow: 0 6px 10px rgba(0, 188, 212, 0.6);
        border: 2px solid rgba(0, 188, 212, 0.5);
    }

    #popper {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        z-index: 1000;
        width: 80%;
        max-width: 600px;
        padding: 20px;
        background-color: #232323;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
        opacity: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        overflow-y: auto;
        max-height: 80%;
        color: #e0e0e0;
    }

    #popper.visible {
        display: block;
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }

    #popper button {
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: #ffdddd;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #popper button:hover {
        background-color: #ffcfd8;
    }

    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 999;
    }

    #overlay.visible {
        display: block;
    }
    
    #here {
        color: rgb(247, 240, 240);
    }
    #here pre{
        background-color: #454444;
        color: white;
    }
    
    .navigation a {
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        transition: background-color 0.3s, color 0.3s;
    }

    .navigation .btn-primary {
        background-color: #2196f3;
        color: white;
    }

    .navigation .btn-primary:hover {
        background-color: #1e88e5;
    }

    .navigation .btn-secondary {
        background-color: #757575;
        color: white;
    }

    .navigation .btn-secondary:hover {
        background-color: #616161;
    }

    .navigation .btn-success {
        background-color: #4caf50;
        color: white;
    }

    .navigation .btn-success:hover {
        background-color: #43a047;
    }
    .audio-button {
        position: absolute;
        right: 52px;
        background-color: rgba(0, 0, 0, 0.01);
        color: #121212;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 24px;
        cursor: pointer;
    }

    .audio-button:hover {
        transform: scale(1.2);
       
    }

    .audio-button.speaking {
        background-color: rgba(255, 64, 64, 0.1);
    }

    /*for each slide*/
    
 
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        #contentSlide .slide {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 25px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        #contentSlide h2 {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-top: 0;
        }

        #contentSlide pre {
            background-color: #363636;
            color: #66ccff;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Consolas', monospace;
            border: 1px solid #444;
        }

        #contentSlide .game-container {
            background-color: #363636;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #444;
        }
        #contentSlide canvas {
            background: #424242;
            border: 2px solid #4CAF50;
            border-radius: 5px;
        }  #contentSlide .sequence-box {
            background: #363636;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        #contentSlide .theory-section {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        #contentSlide .highlight {
            color: #ffeb3b;
            font-weight: bold;
        }

        #contentSlide .practice-section {
            background-color: #383838;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        #contentSlide button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        #contentSlide button:hover {
            background-color: #45a049;
        }

        #contentSlide .output {
            background-color: #424242;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            min-height: 30px;
        }
        #contentSlide .palette, .sequence {
            background-color: #424242;
            padding: 10px;
            border-radius: 8px;
            min-height: 50px;
            margin: 10px 0;
        }

        #contentSlide .command {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            cursor: grab;
            display: inline-block;
        }

        #contentSlide .command:hover {
            background-color: #45a049;
        }

        #contentSlide canvas {
            background: #424242;
            border: 2px solid #4CAF50;
            border-radius: 5px;
        }

        
        
        
        #pen-icon {
            display: none;
            position: absolute;
            font-size: 18px;
            cursor: pointer;
            background: rgb(67, 67, 60);
            color: white;
            border: none;
            border-radius: 20%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        
        }

        /* Explanation Popup */
        #popup {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            z-index: 1000;
            overflow-y: auto;
            color:#1a1a1a;
            max-height:300px;
        }
       
</style>
{% endblock %}

{% block content %}
<div class="slide-container">
    <!-- Testing slide.html changes -->
    <h1>Slide {{ slide.order }}
        <button class="enhancer-button" onclick="sendMagic()">ü™Ñ</button>
        <button class="audio-button" onclick="toggleSpeech()">üîä</button>
    </h1>
    <div id="contentSlide">{{ slide.content|safe }}</div>
    <button id="pen-icon">üîç</button>

    <!-- Explanation Popup -->
    <div id="popup"></div>

    <!-- Popup Window -->
    <div id="overlay"></div>
    <div id="popper">
        <h4>Professor</h4>
        <button onclick="closePop()">‚ùå</button>
        <div id="here">
            <hr style="color: #ede6e6;">
        </div>
    </div>

    
    
    
    
    <div class="navigation d-flex justify-content-between mt-4">
        {% if prev_slide %}
            <a href="{% url 'roadmap_slide' slide.course.id prev_slide.order %}" class="btn btn-secondary">Previous</a>
        {% endif %}
        {% if next_slide %}
            <a href="{% url 'roadmap_slide' slide.course.id next_slide.order %}" class="btn btn-primary">Next</a>
        {% else %}
            {% if is_last_course %}
                <a href="{% url 'roadmap_test' slide.course.stage.id %}" class="btn btn-success">Complete Stage and Take Test</a>
            {% else %}
                <form method="post" class="inline">
                    {% csrf_token %}
                    <button type="submit" name="complete_course" class="btn btn-success inline">Complete Course</button>
                </form>
            {% endif %}
        {% endif %}
    </div>
</div>

<script>
    function getCleanMessage() {
        const contentSlide = document.getElementById('contentSlide');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = contentSlide.innerHTML;
        
        // Remove all script tags
        const scripts = tempDiv.getElementsByTagName('script');
        while(scripts[0]) {
            scripts[0].parentNode.removeChild(scripts[0]);
        }
        
        const cleanText = tempDiv.textContent.trim();
        return cleanText + " Note: Explain the above content in a more understandable manner.";
    }
    async function sendMagic() {
        const popper = document.getElementById("popper");
        const overlay = document.getElementById("overlay");

        popper.classList.add("visible");
        overlay.classList.add("visible");
        
        const message = getCleanMessage()
        console.log(message)
        const area = document.getElementById('here');

        try {
            const response = await fetch('/chat/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            if (!response.ok) throw new Error('Failed to get response');

            const data = await response.json();
            if (data.status === 'success') {
                const horiz = document.createElement('hr');
                area.appendChild(horiz);
                    
                const breaking = document.createElement('br');
                area.appendChild(breaking);
                
                const aiMessageEl = document.createElement('div');
                aiMessageEl.innerHTML =  marked.parse(data.response);
                area.appendChild(aiMessageEl);
                
                area.appendChild(breaking);
                
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        } catch (error) {
            const errorMessageEl = document.createElement('div');
            errorMessageEl.textContent = `Error: ${error.message}`;
            area.appendChild(errorMessageEl);
        }
    }

    function closePop() {
        const popper = document.getElementById("popper");
        const overlay = document.getElementById("overlay");

        popper.classList.remove("visible");
        overlay.classList.remove("visible");
    }
    let speechSynthesis = window.speechSynthesis;
    let speaking = false;

    function getTextContent() {
        const content = document.getElementById('contentSlide');
        // Create temporary container
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content.innerHTML;
        
        // Remove all script tags
        const scripts = tempDiv.getElementsByTagName('script');
        while(scripts[0]) {
            scripts[0].parentNode.removeChild(scripts[0]);
        }
        
        // Get clean text content
        return tempDiv.textContent.trim();
    }

    function toggleSpeech() {
        const audioButton = document.querySelector('.audio-button');
        
        if (speaking) {
            speechSynthesis.cancel();
            speaking = false;
            audioButton.classList.remove('speaking');
            audioButton.textContent = 'üîä';
            return;
        }

        const text = getTextContent();
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.onend = () => {
            speaking = false;
            audioButton.classList.remove('speaking');
            audioButton.textContent = 'üîä';
        };

        speaking = true;
        audioButton.classList.add('speaking');
        audioButton.textContent = 'üîá';
        speechSynthesis.speak(utterance);
    }
    let selectedText = "";

        // Show the pen icon on text selection
        document.addEventListener("mouseup", function (event) {
            let selection = window.getSelection().toString().trim();
            let penIcon = document.getElementById("pen-icon");
            const contentSlide = document.getElementById('contentSlide').textContent;
     

            if (selection.length > 0) {
                selectedText = "I am reading a slide , but now i find it difficult to understand the meaning of the sentence : '"+selection+"' . In brief , short explanation";
                let rect = window.getSelection().getRangeAt(0).getBoundingClientRect();
                penIcon.style.top = `${rect.bottom + window.scrollY - 35}px`;
                penIcon.style.left = `${rect.left + window.scrollX + 30}px`;
                penIcon.style.display = "block";
                
            } else {
                penIcon.style.display = "none";
            }
        });

        // Send selected text to the backend on pen icon click
        document.getElementById("pen-icon").addEventListener("click", async function () {
            let popup = document.getElementById("popup");
            popup.style.display = "block";
            popup.innerHTML = "Researcher is thinking...";

            let penIcon = document.getElementById("pen-icon");
            popup.style.top = `${penIcon.offsetTop + 30}px`;
            popup.style.left = `${penIcon.offsetLeft}px`;

            try {
                let response = await fetch("/chat/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ message: selectedText })
                });

                let data = await response.json();
                popup.innerHTML = "<strong>Explanation:</strong>"+ marked.parse(data.response);
            } catch (error) {
                popup.innerHTML = "Error fetching explanation.";
                console.error(error);
            }
        });

        // Hide the popup when clicking outside
        document.addEventListener("click", function (event) {
            if (!event.target.matches("#pen-icon, #popup")) {
                document.getElementById("popup").style.display = "none";
            }
        });
</script>
{% endblock %}




























































{# remove the above code if you dont like dark theme #}

{% comment lighttheme%}
    
{% extends "main/base.html" %}

{% block styling%}
<style>
    /* General Styles */
    
    h1 {
        position: relative;
        padding: 20px;
        margin: 0;
        font-size: 2.5rem;
        font-weight: 600;
        margin-bottom: 2rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        
    }
    .container{
        background-color: rgb(198, 206, 215);
    }
    /* Enhancer Button */
    .enhancer-button {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: #00b1c1;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .enhancer-button:hover {
        transform: scale(1.2);
        box-shadow: 0 6px 10px rgba(0, 238, 255, 0.6);
        border: 2px solid rgba(0, 153, 255, 0.584);
        
    }

    /* Popper (Popup) */
    #popper {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        z-index: 1000;
        width: 80%;
        max-width: 600px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        overflow-y: auto;
        max-height: 95%;
    }
    #popper.visible {
        display: block;
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }

    /* Close Button */
    #popper button {
        position: fixed;
        top: 1px;
        right: 1px;
        background-color: #ffffff;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        cursor: pointer;
        float: right;
        
    }
    #popper button:hover {
        background-color: #d4b5b5;
    }

    /* Dim Background */
    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }
    #overlay.visible {
        display: block;
    }
    #here{
        overflow-y: auto;
        scroll-behavior:smooth ;
    }
    
    
    
</style>
{% endblock %}


{% block content %}



<div class="slide-container">

<h1>Slide {{ slide.order }}
<button class="enhancer-button" onclick="sendMagic()">ü™Ñ</button>
</h1>
<div id="contentSlide">{{ slide.content|safe }}</div>

<!-- Popup Window -->
<div id="overlay"></div>
<div id="popper">
<h4>ArK - enhancer</h4>
<button onclick="closePop()">‚ùå</button>
<div id="here">
    <!-- Response from AI will go here -->
     <hr>
     
</div>
</div>

<div class="navigation d-flex justify-content-between">
    
    
    {% if prev_slide %}
        <a href="{% url 'roadmap_slide' slide.course.id prev_slide.order %}" class="btn btn-secondary">Previous</a>
    {% endif %}
    {% if next_slide %}
        <a href="{% url 'roadmap_slide' slide.course.id next_slide.order %}" class="btn btn-primary">Next</a>
    {% else %}
        {% if is_last_course %}
            <!-- Redirect to the test page if it's the last course of the stage error causing updateeeeeeeeeeeeeeeeeeeeeeeeeeeeeee -->
            <a href="{% url 'roadmap_test' slide.course.stage.id %}" class="btn btn-success">Complete Stage and Take Test</a>
        {% else %}
            <!-- Redirect to the next course -->
            {% if not next_slide and not is_last_course %}
            <form method="post" class="inline">
                {% csrf_token %}
                <button type="submit" name="complete_course" class="btn btn-success inline">
                    Complete Course
                </button>
            </form>
            {% endif %}
            {% endif %}
            
    {% endif %}
</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


<script>
    
    async function sendMagic(){
        
        const popper = document.getElementById("popper");
        const overlay = document.getElementById("overlay");

        // Show the popup and overlay with animation
        popper.classList.add("visible");
        overlay.classList.add("visible");

        // Add custom animation
        popper.style.animation = "popIn 0.3s ease-out";
        
        let message= document.getElementById('contentSlide').textContent +". Note : Explain the above content in more understanding manner  ";
        let area=document.getElementById('here');
        console.log('well');
        document.addEventListener('DOMContentLoaded', function () {
            console.log(document.getElementById('contentSlide').textContent);
        });
        console.log(document.getElementById('contentSlide').textContent);
        console.log('hi');
        if (message) {
            
    
            try {
                // Show typing indicator
                const typingIndicator = document.createElement('div');
                
                typingIndicator.textContent = '...';
                area.appendChild(typingIndicator);
    
                // Send message to Django backend
                const response = await fetch('/chat/', {  // Update this URL to match your Django URL configuration
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                    })
                });
    
                // Remove typing indicator
                typingIndicator.remove();
    
                if (!response.ok) {
                    throw new Error('Failed to get response'+response.body);
                }
    
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Add AI response
                    const horiz = document.createElement('hr');
                   
                    area.appendChild(horiz);
                    
                    const breaking = document.createElement('br');
                   
                    area.appendChild(breaking);
                    
                    const aiMessageEl = document.createElement('div');
                    aiMessageEl.innerHTML = marked.parse(data.response);
                    area.appendChild(aiMessageEl);
                    area.appendChild(breaking);
                    // Add to message history
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
    
            } catch (error) {
                console.error('Error:', error);
    
                // Add error message
                const errorMessageEl = document.createElement('div');
              
                errorMessageEl.textContent = 'Sorry, there was an error processing your message.'+error;
                area.appendChild(errorMessageEl);
            }
    
            // Scroll to bottom
            area.scrollTop = area.scrollHeight;
            
        }
        
        
    }
    function closePop() {
        const popper = document.getElementById("popper");
        const overlay = document.getElementById("overlay");

        // Hide the popup and overlay
        popper.classList.remove("visible");
        overlay.classList.remove("visible");
    }
   
</script>

{% endblock %}

{% endcomment %}